
<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="X-UA-Compatible" content="ie=edge"/>
<meta name="theme-color" content="#478079"/>

<title>William Arnberg - Game Programmer</title>
<meta name="description" content=''>
<meta name="generator-mode" content='development'>
<style data-generator="critical-css">
</style>
<link
  rel="preload"
  href="/css/bundle.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  
/>
<noscript>
  <link 
    rel="stylesheet"
    href="/css/bundle.css"
    
  />
</noscript>
<link rel="stylesheet" href="http://localhost:1313/scss/adritian.css" integrity="" crossorigin="anonymous"/>



<script defer src="http://localhost:1313/js/color-modes.js"></script>

<script src='http://localhost:1313/js/library/lozad.min.js'></script>

<meta property="og:url" content="http://localhost:1313/articles/ecs_article/">
  <meta property="og:site_name" content="William Arnberg | Game Programmer / Engine Programmer">
  <meta property="og:title" content="Entity-Component-System">
  <meta property="og:description" content="During our second year, I designed and implemented my own Archetype-based ECS in my own game engine.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2024-08-26T09:53:42+02:00">
    <meta property="article:modified_time" content="2024-08-26T09:53:42+02:00">
    <meta property="og:image" content="http://localhost:1313/img/og-img.png">
 

  </head>

  <body>
    

<header class="header fixed-top rad-animation-group" id="header">
  <div class="container rad-fade-in">
    <nav class="navbar bd-navbar navbar-expand-lg navbar-light p-0">
      <div class="container-fluid">
        <a class="navbar-brand mx-auto" href="/">
          <span>William</span>
          <span>Arnberg</span>
        </a>
        <button
          class="navbar-toggler collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent, #header"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-lg-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/"
                >HOME</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#about"
                >ABOUT</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#portfolio"
                >PORTFOLIO</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/articles"
                >PROJECTS</a
              >
            </li>
            
            <li class="nav-item">
              <a data-scroll class="nav-link" href="/#contact"
                >CONTACT</a
              >
            </li>
            
          </ul>
        </div>
      </div>
    </nav>
  </div>
</header>

 <section id="breadcrumb-bar" class="breadcrumb-bar container">
        <ul class="breadcrumbs">
            <li class="breadcrum-item"><span><a href="/">Home</a></span></li><li class="breadcrum-item"><span><a href="/articles">Articles</a></span></li><li class="breadcrum-item current">Entity-Component-System</li></ul>
</section> 


    <section
      id="projects-single"
      class="section section--border-bottom rad-animation-group flex-grow-1"
    >
      <div class="container">
        <h1><a href="/articles/ecs_article/">Entity-Component-System</a></h1>

        <aside id="meta" class="light-border-bottom">
          <div>
            
             
          </div>
        </aside>

        <div class="row flex-column-reverse flex-md-row rad-fade-down">
          <div class="col-12"><p>At the beginning of our second year at <em><strong>The Game Assembly</strong></em> we get the opportunity to build our own game engines, and in the previous year I got a lot of experience working in a more pure object-oriented way using GameObject component systems riddled with virtual functions causing cache misses at every function call.</p>
<p>Having dug through the trenches and seen what problems could arise making games with a object oriented and inheritance based model I felt a major lacking of knowledge towards a the data oriented way of programming I had seen a lot of GDC / CPPCon talks about.<br>
The 2014 CPPcon Mike Acton talk was a huge inspiration.</p>
<h2 id="core-concepts">Core Concepts</h2>
<p>A lot of the code have been stripped for display purposes, if you want the full project with more examples please visit my  <a href="https://github.com/WilliamArnberg/World">Git</a>.</p>
<h5 id="entity">Entity</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#66d9ef">using</span> entity <span style="color:#f92672">=</span> <span style="color:#66d9ef">uint64_t</span>;
</span></span></code></pre></div><p>An entity is a unique identifier that represents a game object. It does not contain any data or logic itself but serves as a reference for components.</p>
<h5 id="components">Components</h5>
<p>Components are user created <a href="https://learn.microsoft.com/en-us/cpp/cpp/trivial-standard-layout-and-pod-types?view=msvc-170#pod-types">POD</a> or Non-POD data structures that store information about an entity.</p>
<h4 id="component-storage">Component Storage</h4>
<p>Each Component type is stored in a column which consists of a contiguous data buffer, and type-erasure information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Column</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>byte[]<span style="color:#f92672">&gt;</span> myBuffer; <span style="color:#75715e">//Component storage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ComponentTypeInfo myTypeInfo; <span style="color:#75715e">//Type Info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	size_t myCapacity{<span style="color:#ae81ff">0</span>}; <span style="color:#75715e">//Amount of bytes this column can hold before needing to grow
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	size_t myCurrentMemoryUsed{<span style="color:#ae81ff">0</span>}; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The Type erasure data each column hold is filled up automatically when the user calls <code>AddComponent&lt;T&gt;();</code>
Storing type-erased constructors enables the use of modern C++ functionalities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ComponentTypeInfo</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ComponentID typeID;
</span></span><span style="display:flex;"><span>	size_t size{<span style="color:#ae81ff">0</span>};											<span style="color:#75715e">// Size of the component type in bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	size_t alignment {<span style="color:#ae81ff">0</span>};										<span style="color:#75715e">// Alignment requirement of the type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>construct)(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aDest) <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;					<span style="color:#75715e">// Function pointer for default construction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>copy)(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aDest, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aSrc) <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;		<span style="color:#75715e">// copy constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>move)(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aDest, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aSrc) <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;				<span style="color:#75715e">// Move constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>destruct)(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> aObj) <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;						<span style="color:#75715e">// Destructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">bool</span> isTrivial <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The columns are stored in an Archetype.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Archetype</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ArchetypeID myID{ <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>    Type myType{};	<span style="color:#75715e">//The order of components in the component list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>unordered_set<span style="color:#f92672">&lt;</span>ComponentID<span style="color:#f92672">&gt;</span> myTypeSet{}; <span style="color:#75715e">//Used for fast lookup into the archetype if it contains a specific type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>Column<span style="color:#f92672">&gt;</span> myComponents{}; <span style="color:#75715e">//Columns holding the data, use the entity row to access the specific component
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>entity<span style="color:#f92672">&gt;</span> myEntities{}; <span style="color:#75715e">//serves as our entity list but the order of entities are also the rows in the component columns
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>unordered_map<span style="color:#f92672">&lt;</span>ComponentID, ArchetypeEdge<span style="color:#f92672">&gt;</span> myEdges{}; <span style="color:#75715e">//Add and remove Edges.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    size_t myMaxCount{<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Putting the design together gives us a clever way of organizing data, empowering us to have fast lookups and fast iterations over contiguous blocks of memory with 0 data fragmentation.<br>
<img alt="image" src="/images/ecs/ECS_Layouts.png"></p>
<h4 id="systems">Systems</h4>
<p>Systems can be added with a simple call of <code>world.system([](){ //Do Stuff },Pipeline::OnUpdate);</code><br>
The ability to pipeline our games in specific segments empowers every decision about the data we are operationg on as we can for a fact know in what state each data is at every point of execution in our codebase.</p>
<h3 id="design-choices">Design Choices</h3>
<p>I began researching the different kind of datalayout variations exisiting Entity-Component-Systems and there is essentially two camps.</p>
<h5 id="sparse-sets">Sparse Sets</h5>
<p>Components are stored in sparse-sets where the entity id&rsquo;s map to the component.<br>
<img src="/images/ecs/sparse.png"></p>
<p>Adding and removing components are O(1), is less complicated and faster than the archetype way.</p>
<h5 id="archetypes">Archetypes</h5>
<p>Components are stored in packed tables of contiguous memory blocks where entities and component ids act as row and column identifiers.</p>
<p>The archetypal pattern seemed intriguing and was at the time easier for me to understand and comprehend, I felt it was easier to reason about.</p>
<p>When desiging the ECS I was deadset on keeping the user interface as simple as possible my mantra was &ldquo;Every programmer on my team need to love using this tool&rdquo;.<br>
The core design pillars I employed were:</p>
<ul>
<li>simplicity</li>
<li>safety</li>
<li>speed</li>
</ul>
<p>Early on in the development developers on my team had a strong wish to be able to store Non-POD datatypes such as strings, vectors and functors.</p>
<!-- raw HTML omitted -->
<h4 id="complete-feature-list">Complete Feature list.</h4>
<ul>
<li>
<p>Cache-Friendly archetype and SoA (Struct of Arrays) storage.</p>
</li>
<li>
<p>Handles POD &amp; non POD datatypes, either by letting the compiler auto generate constructors for you or write your own.</p>
</li>
<li>
<p>Write free floating queries or add functions to systems that automate and structure the pipelining.</p>
</li>
<li>
<p>Easy to type deterministic Queries that return an range-for iterator returning a view class to each entity in that query spanning across multiple archetypes.</p>
</li>
<li>
<p>Filtered Queries for when you need all entities containing N types as long as they don&rsquo;t contain M types.
Returns an range-for iterator returning a view class to each entity in that query spanning across multiple archetypes.</p>
</li>
<li>
<p>Cached Queries, that only gets reset if the underlying memory of the archetype changes.</p>
</li>
</ul>
<h6 id="references">References</h6>
<p><a href="https://research.swtch.com/sparse">https://research.swtch.com/sparse</a></p>
</div>
        </div>

        <aside class="content-browser light-border-top">
            Continue reading
            <div>
                
                    <a class="previous" href="/articles/sp_7/">↩ Game Project 7</a>
                
                 ■ 
                
            </div>
        </aside>
      </div>
    </section>

    <footer class="footer w-100">
  <div class="container">
    <div class="container-fluid">
      <div class="row w-100 align-items-center">
        <div class="footer_left col-12 col-lg-4 mb-3 mb-lg-0 text-center text-lg-start">
          <div class="footer__copy">
            <span></span>
          </div>
        </div>
        <div class="footer_links col-12 col-lg-6 mb-3 mb-lg-0 text-center text-lg-start">
          <ul class="navbar-nav w-100 align-items-center justify-content-center justify-content-lg-start d-flex flex-wrap gap-2">
            <li class="nav-item">
              <a class="nav-link px-2" href="/"
                >🏠 HOME</a
              >
            </li>
            
            <li class="nav-item">
              <a class="nav-link px-2" href="/#about"
                >ABOUT</a
              >
            </li>
            
            <li class="nav-item">
              <a class="nav-link px-2" href="/#portfolio"
                >PORTFOLIO</a
              >
            </li>
            
            <li class="nav-item">
              <a class="nav-link px-2" href="/#contact"
                >CONTACT</a
              >
            </li>
            
          </ul>
        </div>
        <div class="footer_right col-12 col-lg-2 mb-3 mb-lg-0 text-center text-lg-end">
          <div class="d-flex flex-column flex-lg-row justify-content-center align-items-center gap-2">
            
            
            
            <div id="footer-color-selector" class="nav-item dropdown dropup">
              <button
                class="btn btn-link nav-link py-2 px-0 px-lg-2 dropdown-toggle d-flex align-items-center show"
                id="bd-theme"
                type="button"
                aria-expanded="true"
                data-bs-toggle="dropdown"
                data-bs-display="static"
                aria-label="Toggle theme (light)"
              >
                <span class="theme-icon auto d-none" aria-hidden="true"
                  ></span
                >
                <span class="current-theme">✨ Auto</span>
                <span class="d-lg-none ms-2 visually-hidden" id="bd-theme-text"
                  >Toggle theme</span
                >
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end dropup"
                aria-labelledby="bd-theme-text"
                data-bs-popper="static"
              >
                <li>
                  <button
                    type="button"
                    class="dropdown-item d-flex align-items-center active"
                    data-bs-theme-value="light"
                    aria-pressed="true"
                  >
                    ☀️ Light
                  </button>
                </li>
                <li>
                  <button
                    type="button"
                    class="dropdown-item d-flex align-items-center"
                    data-bs-theme-value="dark"
                    aria-pressed="false"
                  >
                    🌑 Dark
                    <span class="theme-icon dark d-none" aria-hidden="true"
                      ></span
                    >
                  </button>
                </li>
                <li>
                  <button
                    type="button"
                    class="dropdown-item d-flex align-items-center"
                    data-bs-theme-value="auto"
                    aria-pressed="false"
                  >
                    ✨ Auto
                    <span class="theme-icon light d-none" aria-hidden="true"
                      ></span
                    >
                  </button>
                </li>
              </ul>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>
 <script>
  window.addEventListener("load", function() {
    try{
      var observer = window.lozad(".lozad", {
        rootMargin: window.innerHeight / 2 + "px 0px",
        threshold: 0.01
      }); 
      observer.observe();
    } catch(e) {
      console.error(e);
    }
  });
</script>
<script defer src='http://localhost:1313/js/rad-animations.js'></script>
<script defer src='http://localhost:1313/js/library/smooth-scroll.polyfills.min.js'></script>
<script defer src='http://localhost:1313/js/sticky-header.js'></script>
<script defer src='http://localhost:1313/js/smooth-scroll-init.js'></script>
<script defer src='http://localhost:1313/js/library/bootstrap.bundle.min.js'></script>



<script>
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
  </body>
</html>

